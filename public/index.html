<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Runway Automation Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- FIREBASE SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --------------------------------------------------------------
    // REPLACE WITH YOUR FIREBASE CONFIG
    // --------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- API BRIDGE ---
    async function apiCall(action, data = {}) {
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            const res = await fetch('/api/db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, uid: user.uid, email: user.email, data })
            });
            return await res.json();
        } catch(e) { console.error("API Error:", e); }
    }

    // --- AUTH STATE ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('loginScreen').style.display = 'none';
        
        // Check Trial Status
        const data = await apiCall('register_user');
        const status = data.status;
        
        if (status === 'expired') {
            document.getElementById('expiredScreen').style.display = 'flex';
            return;
        }

        document.getElementById('appScreen').style.display = 'flex';
        document.getElementById('userEmail').innerText = user.email;
        
        if (status === 'trial') {
            document.getElementById('trialBanner').style.display = 'block';
            document.getElementById('trialTime').innerText = Math.ceil(data.hoursLeft) + 'h';
        }

        // Load Settings
        const settingsRes = await apiCall('get_settings');
        const settings = settingsRes.settings;
        if(settings && settings.clicks) {
            document.getElementById('clicks-assets').value = settings.clicks.assets || 1;
            document.getElementById('clicks-image').value = settings.clicks.image || 2;
            document.getElementById('clicks-remove').value = settings.clicks.remove || 1;
        }
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appScreen').style.display = 'none';
        document.getElementById('expiredScreen').style.display = 'none';
      }
    });

    // --- ACTIONS ---
    window.login = async () => {
        try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
        catch (e) { document.getElementById('authError').innerText = e.message; }
    };
    window.signup = async () => {
        try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
        catch (e) { document.getElementById('authError').innerText = e.message; }
    };
    window.loginGoogle = async () => {
        try { await signInWithPopup(auth, googleProvider); }
        catch (e) { document.getElementById('authError').innerText = e.message; }
    };
    window.logout = () => signOut(auth);

    window.send = (type, data) => {
        const clicks = {
            assets: document.getElementById('clicks-assets').value,
            image: document.getElementById('clicks-image').value,
            remove: document.getElementById('clicks-remove').value
        };
        const force = document.getElementById('forceAssets').checked;
        
        apiCall('save_settings', { clicks, force }); // Save to DB

        window.parent.postMessage({ 
            type: type, target: data, clicks: clicks, forceAssets: force 
        }, "*");
    };

    window.startAutomation = () => {
        const fileInput = document.getElementById('csvFile');
        const folder = document.getElementById('folderSelect').value;
        
        if(!fileInput.files[0]) { alert("Drag & Drop a CSV file first!"); return; }
        if(!folder || folder.includes("Loading")) { alert("Select a Source Folder"); return; }

        const reader = new FileReader();
        reader.onload = (e) => window.send('START_AUTOMATION', { csvText: e.target.result, folderId: folder });
        reader.readAsText(fileInput.files[0]);
    };
    
    // Listeners
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('csvFile');
    const dropText = document.getElementById('dropText');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    
    // FIXED LINE BELOW: removed extra });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover')); 
    
    dropZone.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        dropZone.classList.remove('dragover'); 
        if(e.dataTransfer.files.length) { 
            fileInput.files = e.dataTransfer.files; 
            handleFileSelect(); 
        } 
    });
    
    fileInput.addEventListener('change', handleFileSelect);
    
    function handleFileSelect() { 
        if(fileInput.files.length) { 
            dropZone.classList.add('has-file'); 
            dropText.innerHTML = `üìÑ ${fileInput.files[0].name}`; 
            document.querySelector('.drop-sub').innerText = "Click to change"; 
        } 
    }

    // Listen for Extension Messages
    window.addEventListener('message', (event) => {
        const msg = event.data;
        if (msg.type === 'STATUS_UPDATE') {
            const b = document.getElementById('statusBox');
            b.innerText = msg.text; if(msg.color) b.style.color = msg.color;
        }
        if (msg.type === 'FOLDER_LIST') {
            const sel = document.getElementById('folderSelect'); sel.innerHTML = "";
            msg.folders.forEach(f => { const o = document.createElement('option'); o.value = f.id; o.text = f.name; sel.appendChild(o); });
        }
        if (msg.type === 'TRAIN_STATUS') {
            Object.keys(msg.status).forEach(k => {
                const d = document.getElementById('dot-'+k);
                if(d) {
                    d.style.background = msg.status[k] ? '#22c55e' : '#ef4444';
                    d.style.boxShadow = msg.status[k] ? '0 0 8px rgba(34,197,94,0.5)' : 'none';
                }
            });
        }
        if (msg.type === 'HISTORY_UPDATE') {
            document.getElementById('historyStatus').innerText = `History: ${msg.count} items`;
        }
    });

    // Init
    setTimeout(() => window.send('INIT'), 500);
  </script>

  <style>
    /* === THEME === */
    :root {
      --bg: #050816; --bg-panel: #0b0b0f; --bg-input: #131316;
      --border-color: #27272a; --border-subtle: rgba(30, 64, 175, 0.6);
      --text-main: #e2e8f0; --text-muted: #94a3b8;
      --accent-cyan: #06b6d4; --accent-green: #22c55e;
      --gradient-primary: linear-gradient(135deg, #9d4edd, #ff007f);
      --gradient-primary-hover: linear-gradient(135deg, #ff007f, #f97316);
      --radius-lg: 18px; --radius-pill: 999px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; width: 100%; height: 100vh; font-family: 'Inter', sans-serif; background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.12), transparent 55%), var(--bg); color: var(--text-main); overflow: hidden; }
    .app-shell { padding: 16px; display: flex; flex-direction: column; gap: 12px; height: 100%; }
    
    /* SCREENS */
    #loginScreen, #expiredScreen { display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 15px; text-align: center; }
    #appScreen { display: none; flex-direction: column; gap: 12px; height: 100%; }
    #expiredScreen { display: none; }

    /* TRIAL BANNER */
    #trialBanner { 
        display: none; background: linear-gradient(90deg, #ff9900, #ff5500); 
        color: white; font-size: 10px; text-align: center; padding: 4px; 
        border-radius: 4px; margin-bottom: 8px; font-weight: bold;
    }

    /* HEADER */
    .header { display: flex; justify-content: space-between; align-items: flex-start; }
    .brand-title { font-size: 16px; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
    .pill { padding: 2px 6px; border-radius: var(--radius-pill); font-size: 9px; border: 1px solid rgba(148, 163, 184, 0.5); color: var(--text-muted); }
    .brand-subtitle { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    .social-link { text-decoration: none; font-size: 9px; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; display: flex; align-items: center; gap: 4px; margin-top: 5px; }
    .social-link:hover { border-color: var(--accent-cyan); color: white; }

    /* PANEL */
    .panel { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 8px; position: relative; overflow: hidden; }
    .panel::before { content: ""; position: absolute; inset: -40%; background: radial-gradient(circle at top left, rgba(217, 70, 239, 0.08), transparent 55%); pointer-events: none; }
    .section-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .section-label::after { content: ""; flex: 1; height: 1px; background: linear-gradient(to right, rgba(148, 163, 184, 0.3), transparent); }

    /* TRAINING */
    .train-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.02); padding: 5px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
    .train-row:hover { border-color: rgba(255,255,255,0.1); }
    .row-info { display: flex; align-items: center; gap: 8px; flex: 1; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #333; box-shadow: 0 0 0 1px rgba(255,255,255,0.1); transition:0.3s; }
    .label-text { font-size: 11px; font-weight: 500; }

    /* INPUTS */
    .styled-select { background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-subtle); border-radius: 4px; padding: 2px; font-size: 10px; margin-right: 4px; cursor: pointer; }
    .main-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border-subtle); color: var(--text-main); padding: 8px; border-radius: 8px; font-size: 11px; margin-bottom: 6px; outline: none; transition:0.2s; }
    .main-input:focus { border-color: var(--accent-cyan); }

    /* DRAG & DROP ZONE */
    .drop-zone {
        width: 100%; border: 1px dashed var(--border-subtle); border-radius: 8px;
        background: rgba(255,255,255,0.02); padding: 15px; text-align: center;
        cursor: pointer; transition: 0.2s; display: flex; flex-direction: column;
        align-items: center; justify-content: center; gap: 4px;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent-cyan); background: rgba(6, 182, 212, 0.05); }
    .drop-zone.has-file { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); border-style: solid; }
    .drop-text { font-size: 11px; color: var(--text-main); font-weight: 500; }
    .drop-sub { font-size: 9px; color: var(--text-muted); }
    .file-icon { font-size: 18px; margin-bottom: 2px; }

    /* BUTTONS */
    .btn { border: none; border-radius: 999px; padding: 6px 12px; font-size: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; }
    .btn-outline { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); color: var(--text-muted); }
    .btn-outline:hover { border-color: var(--text-main); color: white; }
    .btn-primary { background: var(--gradient-primary); color: white; width: 100%; padding: 10px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; box-shadow: 0 4px 12px rgba(217, 70, 239, 0.3); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(217, 70, 239, 0.5); }
    
    .status-banner { font-size: 10px; padding: 8px; border-radius: 8px; background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); color: var(--accent-cyan); text-align: center; margin-top: 6px; }
    .history-row { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-muted); padding: 0 4px; margin-top: 4px; }
    .link-btn { background:none; border:none; color: #ef4444; text-decoration:underline; cursor:pointer; font-size:9px; }
    
    .user-bar { display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: var(--text-muted); margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
    .google-btn {
      background: white; color: #333; border: none; width: 100%; padding: 10px;
      border-radius: 999px; font-size: 12px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px;
    }
    .google-btn:hover { background: #f1f1f1; }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <!-- LOGIN -->
    <div id="loginScreen">
      <div class="brand-title" style="font-size:20px; justify-content:center;">Runway Pro</div>
      <div style="font-size:11px; color:#888;">Secure Access Required</div>
      
      <input type="email" id="email" class="main-input" placeholder="Email" />
      <input type="password" id="password" class="main-input" placeholder="Password" />
      
      <button onclick="window.login()" class="btn btn-primary">Login</button>
      <button onclick="window.loginGoogle()" class="google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="16">
        Sign in with Google
      </button>
      <button onclick="window.signup()" class="btn btn-outline" style="width:100%; justify-content:center; margin-top:5px;">Create Account</button>
      <div id="authError" style="color:#ef4444; font-size:10px; margin-top:5px;"></div>
    </div>

    <!-- EXPIRED SCREEN -->
    <div id="expiredScreen">
        <div style="font-size:40px;">üîí</div>
        <div class="brand-title" style="font-size:20px; justify-content:center;">Trial Expired</div>
        <p style="font-size:11px; color:#888; line-height:1.5;">
            Your 24-hour trial has ended.<br>
            Please upgrade to continue using Runway Pro.
        </p>
        <button class="btn btn-primary">Upgrade Now</button>
        <span onclick="window.logout()" class="link-btn" style="margin-top:15px;">Logout</span>
    </div>

    <!-- APP -->
    <div id="appScreen">
      <div class="header">
        <div class="brand">
          <div class="brand-title">Runway Automation <span class="pill">PRO</span></div>
          <div class="brand-subtitle">Powered by <span class="powered-by">Moin Datori</span></div>
          <div class="social-row">
            <a href="https://www.youtube.com/channel/UC7otDLkBsEsMstspQN6FpWw" target="_blank" class="social-link"><span class="yt-icon">‚ñ∂</span> YouTube</a>
            <a href="https://chat.whatsapp.com/F022Xf2DFAr3seGowwlUN5" target="_blank" class="social-link"><span class="wa-icon">üí¨</span> WhatsApp</a>
          </div>
        </div>
      </div>

      <div class="user-bar">
        <span>User: <span id="userEmail" style="color:#fff;">...</span></span>
        <span onclick="window.logout()" style="cursor:pointer; text-decoration:underline;">Logout</span>
      </div>

      <div id="trialBanner">‚è≥ Trial Active: <span id="trialTime">24h</span> remaining</div>

      <div class="panel">
        <div class="section-label">TRAINING</div>
        <div class="train-grid">
            <div class="train-row">
                <div class="row-info"><div class="status-dot" id="dot-assets"></div><span class="label-text">1. Assets</span></div>
                <select id="clicks-assets" class="styled-select"><option value="1">1x</option><option value="2">2x</option></select>
                <button class="btn btn-outline" onclick="window.send('TRAIN','assets')">Train</button>
            </div>
            <div class="train-row">
                <div class="row-info"><div class="status-dot" id="dot-search"></div><span class="label-text">2. Search</span></div>
                <button class="btn btn-outline" onclick="window.send('TRAIN','search')">Train</button>
            </div>
            <div class="train-row">
                <div class="row-info"><div class="status-dot" id="dot-image"></div><span class="label-text">3. Image</span></div>
                <select id="clicks-image" class="styled-select"><option value="1">1x</option><option value="2" selected>2x</option></select>
                <button class="btn btn-outline" onclick="window.send('TRAIN','image')">Train</button>
            </div>
            <div class="train-row">
                <div class="row-info"><div class="status-dot" id="dot-remove"></div><span class="label-text">4. Remove</span></div>
                <select id="clicks-remove" class="styled-select"><option value="1">1x</option></select>
                <button class="btn btn-outline" onclick="window.send('TRAIN','remove')">Train</button>
            </div>
            <div class="train-row">
                <div class="row-info"><div class="status-dot" id="dot-prompt"></div><span class="label-text">5. Prompt</span></div>
                <button class="btn btn-outline" onclick="window.send('TRAIN','prompt')">Train</button>
            </div>
        </div>
      </div>

      <div class="panel">
        <div class="section-label">EXECUTION</div>
        
        <div>
            <label style="font-size:9px; color:#94a3b8;">SOURCE FOLDER</label>
            <select id="folderSelect" class="main-input"><option>Loading...</option></select>
        </div>

        <div id="dropZone" class="drop-zone">
            <div class="file-icon">üìÇ</div>
            <span id="dropText" class="drop-text">Drag & Drop CSV Here</span>
            <span class="drop-sub">or click to browse</span>
            <input type="file" id="csvFile" accept=".csv" hidden />
        </div>

        <div style="display:flex; align-items:center; gap:6px; margin:6px 0;">
            <input type="checkbox" id="forceAssets" checked>
            <label for="forceAssets" style="font-size:9px; color:#94a3b8;">Force Sidebar Open</label>
        </div>

        <div class="history-row">
            <span id="historyStatus">History: 0 items</span>
            <button onclick="window.send('CLEAR_HISTORY')" class="link-btn">Clear</button>
        </div>

        <button onclick="window.startAutomation()" class="btn btn-primary">üöÄ Start Automation</button>
        <div class="status-banner"><span id="statusBox">Ready.</span></div>
      </div>
    </div>

  </div>
</body>
</html>
